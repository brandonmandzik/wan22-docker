services:
  wan22:
    # Image source determined by MODE in .env file
    # MODE=build: builds from Dockerfile
    # MODE=pull: pulls from ${DOCKER_IMAGE}
    image: ${LOCAL_IMAGE_TAG:-wan22-t2v:latest}
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wan22-inference
    ipc: host
    netwrork: host
    gpus: all
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - PYTORCH_CUDA_ALLOC_CONF: "expandable_segments:True"
    ulimits:
      memlock: -1
      stack: 67108864
    volumes:
      # Wan2.2 working directory (checkpoints, outputs, everything)
      - /opt/Wan2.2:/Wan2.2
    working_dir: /workspace/wan2.2
    stdin_open: true
    tty: true
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
